# システムアーキテクチャ仕様書

## 1. システム概要

**目的**: HTML形式の数学問題をWord文書に変換し、統一されたスタイルで出力する

**主要機能**:
- HTML解析と構造化データ抽出
- LaTeX数式の画像変換
- Word文書の自動生成
- スタイルテンプレート管理

## 2. アーキテクチャ図

┌─────────────────────────────────────────────────┐ │ 入力層 │ │ ┌──────────┐ ┌──────────┐ ┌──────────┐ │ │ │ HTML │ │ スタイル │ │ テンプレ │ │ │ │ ファイル │ │ 設定 │ │ ート │ │ │ └──────────┘ └──────────┘ └──────────┘ │ └─────────────────────────────────────────────────┘ ↓ ┌─────────────────────────────────────────────────┐ │ 処理層 │ │ ┌──────────────────────────────────────────┐ │ │ │ HTMLParser │ │ │ │ - 問題構造の解析 │ │ │ │ - テキストと数式の分離 │ │ │ │ - 選択肢の抽出 │ │ │ └──────────────────────────────────────────┘ │ │ ↓ │ │ ┌──────────────────────────────────────────┐ │ │ │ MathConverter │ │ │ │ - LaTeX → PNG画像変換 │ │ │ │ - 高解像度レンダリング │ │ │ │ - 透過背景処理 │ │ │ └──────────────────────────────────────────┘ │ │ ↓ │ │ ┌──────────────────────────────────────────┐ │ │ │ WordGenerator │ │ │ │ - 文書構造の生成 │ │ │ │ - スタイル適用 │ │ │ │ - 画像の埋め込み │ │ │ └──────────────────────────────────────────┘ │ └─────────────────────────────────────────────────┘ ↓ ┌─────────────────────────────────────────────────┐ │ 出力層 │ │ ┌──────────┐ ┌──────────┐ ┌──────────┐ │ │ │ Word │ │ ログ │ │ エラー │ │ │ │ 文書 │ │ ファイル │ │ レポート │ │ │ └──────────┘ └──────────┘ └──────────┘ │ └─────────────────────────────────────────────────┘


## 3. モジュール構成

### 3.1 コアモジュール (src/core/)

**style_config.py**
- 役割: システム全体のスタイル設定を管理
- 依存: なし
- 出力: STYLE_CONFIG辞書、TEMPLATES辞書

**html_parser.py**
- 役割: HTMLの解析と構造化データへの変換
- 依存: BeautifulSoup4, re
- 入力: HTML文字列
- 出力: 問題データのリスト

**math_converter.py**
- 役割: LaTeX数式を画像に変換
- 依存: matplotlib, PIL
- 入力: LaTeX文字列
- 出力: PNG画像バイナリ

**word_generator.py**
- 役割: Word文書の生成
- 依存: python-docx
- 入力: 問題データリスト、スタイル設定
- 出力: Word文書オブジェクト

## 4. データフロー

### 4.1 変換プロセス

**ステップ1: HTML読み込み**
HTMLファイル → 文字列データ


**ステップ2: 解析**
HTML文字列 → HTMLParser → 構造化データ { 'title': '大問1', 'text': [{'type': 'text', 'content': '...'}, ...], 'equations': ['x^2 + 5x + 6 = 0'], 'choices': ['x = -2, -3', ...] }


**ステップ3: 数式変換**
LaTeX文字列 → MathConverter → PNG画像 'x^2 + 5x + 6 = 0' → [画像バイナリデータ]


**ステップ4: 文書生成**
構造化データ + 画像 → WordGenerator → Word文書


**ステップ5: 保存**
Word文書オブジェクト → .docxファイル


## 5. 設計原則

### 5.1 モジュール独立性
各モジュールは独立して動作し、他のモジュールへの依存を最小限に抑えています。

### 5.2 設定の外部化
スタイル設定はすべて`style_config.py`に集約し、コードの変更なしにカスタマイズ可能です。

### 5.3 エラーハンドリング
各処理段階でエラーを捕捉し、適切なフォールバック処理を実行します。

### 5.4 拡張性
新しいテンプレートやスタイルを簡単に追加できる構造になっています。

## 6. パフォーマンス考慮事項

### 6.1 メモリ使用
- 画像は必要な時に生成し、即座に文書に埋め込む
- 大量の問題を処理する場合でもメモリ使用量を抑制

### 6.2 処理速度
- 数式変換が最も時間がかかる処理
- 1問あたり約0.5〜1秒の処理時間（数式の複雑さによる）

### 6.3 ファイルサイズ
- 高解像度画像により、1問あたり約50〜100KBのファイルサイズ増加
- 10問の文書で約1〜2MBのファイルサイズ

## 7. セキュリティ考慮事項

### 7.1 入力検証
- HTMLタグの妥当性チェック
- LaTeX文字列の安全性確認
- ファイルパスの検証

### 7.2 リソース制限
- 画像サイズの上限設定
- 処理時間のタイムアウト設定

## 8. 今後の拡張予定

### Phase 2: プロンプトテンプレート
- AI生成用の標準プロンプト
- HTML構造の検証機能

### Phase 3: GUI実装
- PySide6ベースのユーザーインターフェース
- プレビュー機能

### Phase 4: バッチ処理
- 複数ファイルの一括変換
- フォルダ監視機能

### Phase 5: AI統合
- LM Studioとの連携
- 自動問題生成
